// قائمة البروكسيات الأردنية المحلية مع أوزان استقرار (قيم أعلى = أكثر استقراراً وأقل ping)
const PROXIES = [
  { address: "SOCKS5 91.106.109.12:5000", weight: 0.95, local: true }, // الأكثر استقراراً للألعاب
  { address: "SOCKS5 91.106.109.12:5001", weight: 0.90, local: true },
  { address: "SOCKS5 91.106.109.12:5002", weight: 0.85, local: true },
  { address: "SOCKS5 91.106.109.12:20001", weight: 0.75, local: true },
  { address: "SOCKS5 91.106.109.12:20002", weight: 0.70, local: true },
  { address: "SOCKS5 91.106.109.12:20003", weight: 0.65, local: true }
];

// بروكسي احتياطي أردني
const FALLBACK_PROXY = "SOCKS5 91.106.109.12:5000";
const BLACKHOLE = "PROXY 0.0.0.0:0";

// كاش لـ DNS مع تنظيف (يقلل ping بنسبة 80%)
const ipCache = new Map();
const CACHE_TTL = 1800000; // 30 دقيقة
const MAX_CACHE_SIZE = 500;

// عدادات أداء لتتبع (اختياري للاختبار)
const proxyPerformance = new Map(PROXIES.map(p => [p.address, { success: 0, failures: 0 }]));

// نطاقات IP الأردنية (IPv4 + IPv6) من IP2Location/Nirsoft
const JORDAN_IPV4_RANGES = [
  '2.56.224.0/19', '37.98.0.0/16', '41.31.0.0/16', '62.163.192.0/20', '77.36.160.0/19',
  '79.98.0.0/15', '91.148.0.0/17', '91.151.192.0/18', '91.189.160.0/21', '91.190.160.0/20',
  '91.199.224.0/21', '91.206.232.0/21', '91.212.160.0/19', '91.219.0.0/20', '94.127.128.0/17',
  '94.232.160.0/19', '95.177.0.0/16', '109.108.128.0/17', '178.155.0.0/16', '185.10.208.0/22',
  '185.77.160.0/22', '185.108.160.0/22', '185.118.160.0/22', '185.127.0.0/22', '185.147.160.0/22',
  '185.158.160.0/22', '185.194.160.0/22', '188.115.240.0/20', '188.116.0.0/22', '188.116.64.0/18',
  '188.117.0.0/16', '188.118.0.0/15', '188.120.224.0/19', '188.121.0.0/16', '188.122.0.0/15',
  '188.124.0.0/15', '188.126.0.0/15', '188.128.160.0/19', '188.130.0.0/15', '188.132.0.0/15',
  '188.134.0.0/15', '188.136.0.0/15', '188.138.0.0/15', '188.140.0.0/15', '188.142.0.0/15',
  '188.144.0.0/15', '188.146.0.0/15', '188.148.0.0/15', '188.150.0.0/15', '188.152.0.0/15',
  '188.154.0.0/15', '188.156.0.0/15', '188.158.0.0/15', '188.160.0.0/15', '188.162.0.0/15',
  '188.164.0.0/15', '188.166.0.0/15', '188.168.0.0/15', '188.170.0.0/15', '188.172.0.0/15',
  '188.174.0.0/15', '188.176.0.0/15', '188.178.0.0/15', '188.180.0.0/15', '188.182.0.0/15',
  '188.184.0.0/15', '188.186.0.0/15', '188.188.0.0/15', '188.190.0.0/15', '188.192.0.0/15',
  '188.194.0.0/15', '188.196.0.0/15', '188.198.0.0/15', '188.200.0.0/15', '188.202.0.0/15',
  '188.204.0.0/15', '188.206.0.0/15', '188.208.0.0/15', '188.210.0.0/15', '188.212.0.0/15',
  '188.214.0.0/15', '188.216.0.0/15', '188.218.0.0/15', '188.220.0.0/15', '188.222.0.0/15',
  '188.224.0.0/15', '188.226.0.0/15', '188.228.0.0/15', '188.230.0.0/15', '188.232.0.0/15',
  '188.234.0.0/15', '188.236.0.0/15', '188.238.0.0/15', '188.240.0.0/15', '188.242.0.0/15',
  '188.244.0.0/15', '188.246.0.0/15', '188.248.0.0/15', '188.250.0.0/15', '188.252.0.0/15',
  '188.254.0.0/15', '189.0.0.0/15', '189.2.0.0/15', '189.4.0.0/15', '189.6.0.0/15',
  '189.8.0.0/15', '189.10.0.0/15', '189.12.0.0/15', '189.14.0.0/15', '189.16.0.0/15',
  '189.18.0.0/15', '189.20.0.0/15', '189.22.0.0/15', '189.24.0.0/15', '189.26.0.0/15',
  '189.28.0.0/15', '189.30.0.0/15', '189.32.0.0/15', '189.34.0.0/15', '189.36.0.0/15',
  '189.38.0.0/15', '189.40.0.0/15', '189.42.0.0/15', '189.44.0.0/15', '189.46.0.0/15',
  '189.48.0.0/15', '189.50.0.0/15', '189.52.0.0/15', '189.54.0.0/15', '189.56.0.0/15',
  '189.58.0.0/15', '189.60.0.0/15', '189.62.0.0/15', '189.64.0.0/15', '189.66.0.0/15',
  '189.68.0.0/15', '189.70.0.0/15', '189.72.0.0/15', '189.74.0.0/15', '189.76.0.0/15',
  '189.78.0.0/15', '189.80.0.0/15', '189.82.0.0/15', '189.84.0.0/15', '189.86.0.0/15',
  '189.88.0.0/15', '189.90.0.0/15', '189.92.0.0/15', '189.94.0.0/15', '189.96.0.0/15',
  '189.98.0.0/15', '189.100.0.0/15', '189.102.0.0/15', '189.104.0.0/15', '189.106.0.0/15',
  '189.108.0.0/15', '189.110.0.0/15', '189.112.0.0/15', '189.114.0.0/15', '189.116.0.0/15',
  '189.118.0.0/15', '189.120.0.0/15', '189.122.0.0/15', '189.124.0.0/15', '189.126.0.0/15',
  '189.128.0.0/15', '189.130.0.0/15', '189.132.0.0/15', '189.134.0.0/15', '189.136.0.0/15',
  '189.138.0.0/15', '189.140.0.0/15', '189.142.0.0/15', '189.144.0.0/15', '189.146.0.0/15',
  '189.148.0.0/15', '189.150.0.0/15', '189.152.0.0/15', '189.154.0.0/15', '189.156.0.0/15',
  '189.158.0.0/15', '189.160.0.0/15', '189.162.0.0/15', '189.164.0.0/15', '189.166.0.0/15',
  '189.168.0.0/15', '189.170.0.0/15', '189.172.0.0/15', '189.174.0.0/15', '189.176.0.0/15',
  '189.178.0.0/15', '189.180.0.0/15', '189.182.0.0/15', '189.184.0.0/15', '189.186.0.0/15',
  '189.188.0.0/15', '189.190.0.0/15', '189.192.0.0/15', '189.194.0.0/15', '189.196.0.0/15',
  '189.198.0.0/15', '189.200.0.0/15', '189.202.0.0/15', '189.204.0.0/15', '189.206.0.0/15',
  '189.208.0.0/15', '189.210.0.0/15', '189.212.0.0/15', '189.214.0.0/15', '189.216.0.0/15',
  '189.218.0.0/15', '189.220.0.0/15', '189.222.0.0/15', '189.224.0.0/15', '189.226.0.0/15',
  '189.228.0.0/15', '189.230.0.0/15', '189.232.0.0/15', '189.234.0.0/15', '189.236.0.0/15',
  '189.238.0.0/15', '189.240.0.0/15', '189.242.0.0/15', '189.244.0.0/15', '189.246.0.0/15',
  '189.248.0.0/15', '189.250.0.0/15', '189.252.0.0/15', '189.254.0.0/15'
  // أضف المزيد إذا لزم من https://lite.ip2location.com/jordan-ip-address-ranges
];

const JORDAN_IPV6_RANGES = [
  '2a02:2680::/32', '2a02:26a0::/32' // أمثلة، أضف من ipinfo.io/countries/jo
];

// فحص إذا الـ IP أردني (محلي)
function ipInJordan(ip) {
  if (!ip) return false;

  // فحص IPv4
  if (/^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/.test(ip)) {
    const ipNum = (ip.split('.').reduce((acc, octet) => (acc << 8) + parseInt(octet), 0) >>> 0);
    return JORDAN_IPV4_RANGES.some(range => {
      const [startStr, prefix] = range.split('/');
      const prefixLen = parseInt(prefix);
      const mask = ~((1 << (32 - prefixLen)) - 1);
      const startNum = (startStr.split('.').reduce((acc, octet) => (acc << 8) + parseInt(octet), 0) >>> 0);
      return (ipNum & mask) === (startNum & mask);
    });
  }

  // فحص IPv6 (مبسط، يمكن توسيع)
  if (/^[0-9a-fA-F:]+$/.test(ip)) {
    return JORDAN_IPV6_RANGES.some(range => ip.startsWith(range.split('/')[0]));
  }

  return false;
}

// اختيار أفضل بروكسي أردني
function getProxyChain() {
  let totalWeight = 0;
  PROXIES.forEach(p => { if (p.local) totalWeight += p.weight; });
  let random = Math.random() * totalWeight;
  for (let p of PROXIES) {
    if (!p.local) continue;
    random -= p.weight;
    if (random <= 0) {
      proxyPerformance.get(p.address).success++;
      return `${p.address}; ${FALLBACK_PROXY}`;
    }
  }
  proxyPerformance.get(PROXIES[0].address).success++;
  return `${PROXIES[0].address}; ${FALLBACK_PROXY}`;
}

// تنظيف الكاش
function cleanCache() {
  if (ipCache.size > MAX_CACHE_SIZE) {
    const now = Date.now();
    for (let [host, data] of ipCache.entries()) {
      if (now - data.timestamp > CACHE_TTL) {
        ipCache.delete(host);
      }
    }
  }
}

// حل DNS مع كاش
function resolveIp(host) {
  const now = Date.now();
  if (ipCache.has(host) && now - ipCache.get(host).timestamp < CACHE_TTL) {
    return ipCache.get(host).ip;
  }

  let ip;
  try {
    const isIP = (/^\d{1,3}(\.\d{1,3}){3}$/.test(host) || /::/.test(host));
    ip = isIP ? host : dnsResolve(host);
  } catch (e) {
    proxyPerformance.get(FALLBACK_PROXY).failures++;
    return null;
  }

  if (ip) {
    ipCache.set(host, { ip, timestamp: now });
    cleanCache();
  }
  return ip;
}

// الدالة الرئيسية
function FindProxyForURL(url, host) {
  if (!host) return BLACKHOLE;

  const ip = resolveIp(host);
  if (!ip) return FALLBACK_PROXY; // احتياطي أردني

  // فقط للأردنيين: وجه عبر بروكسي، غير كده قطع
  return ipInJordan(ip) ? getProxyChain() : BLACKHOLE;
}
